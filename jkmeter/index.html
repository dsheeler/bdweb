<!DOCTYPE html>
<html>
<head>
  <title>jkmeter Web Audio Clone</title>
  <meta charset="utf-8">
  <!--<link rel="shortcut icon" href="/favicon.png"> -->

  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>

  <script type="text/javascript" src="../peakmeter.js"></script>
  <script type="text/javascript" src="../adapter.js"></script>
  <script>
window.requestAnimationFrame = window.requestAnimationFrame 
 || window.mozRequestAnimationFrame 
 || window.webkitRequestAnimationFrame 
 || window.msRequestAnimationFrame;

window.onload = init;

var aContext;
var context;
var oConext;
var canvas;
var meters = [];
var names = ['peakl', 'peakr'];

function init() {
  var canvases = [];
  canvases[0] = document.querySelector('#peakl');
  canvases[1] = document.querySelector('#peakr');
  canvases[0].style.width = canvases[1].style.width = '60px';
  canvases[0].style.height = canvases[1].style.height = '480px';
  canvases[0].width = canvases[1].width = 60;
  canvases[0].height = canvases[1].height = 480;

  var actxCall = window.webkitAudioContext || window.AudioContext;
  aContext = new actxCall();

  for (var channel = 0; channel < 2; channel++) {
    meters[channel] = new PeakMeter(names[channel], aContext, channel);
  }

  requestAnimationFrame(function(timestamp) {
    for (var i = 0; i < meters.length; i++) {
      meters[i].update(timestamp);
    }
  });
  startMedia();
}

function startMedia() {
  var constraints = {audio: true};
  getUserMedia(constraints, handleUserMedia, handleUserMediaError);
  console.log('Getting user media with constraints', constraints);
}

function handleUserMedia(stream) {
  var microphone = aContext.createMediaStreamSource(stream);
  for (var i = 0; i < meters.length; i++) {
    microphone.connect(meters[i].getAudioNode());
    meters[i].getAudioNode().connect(aContext.destination);
  }
}

function handleUserMediaError(error){
  console.log('navigator.getUserMedia error: ', error);
}

</script>
</head>
<body>
  <div id='container'>
    <canvas id='peakl'></canvas>
    <canvas id='peakr'></canvas>
  </div>
</body>
</html>
