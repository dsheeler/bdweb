<!DOCTYPE html>
<html>
<head>
  <title>Web Fun</title>
  <meta charset="utf-8">
  <!--<link rel="shortcut icon" href="/favicon.png"> -->

  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
  <script src="//europa.kradradio.com:8040/mootools-core-1.4.5-full-nocompat.js"></script>
  <script src="//europa.kradradio.com:8040/mootools-more-1.4.0.1.js"></script>

  <script type="text/javascript" src="adapter.js"></script>
  <script type="text/javascript" src="sinewave.js"></script>
  <script>

window.onload = init;
var oldData;
var fuckData;
var newData;
var threshold = 75;

var aContext;
var oConext;
var output;
var localVideo;
var points = [];
var xLoc,yLoc,mag,circleCenterX,circleCenterY,radius;
xLoc = 0;
yLoc = 0;
var xMin,xMax,yMin,yMax;
xMin = 0;
xMax = 640;
yMin = -1;
yMax = -99999999;
var numNeighborsX;
var numNeighborsY;
var circleCentersX;
var circleCentersY;
var patchSums;
var oldDataCheck = -1;
circleCentersX = {'data':[]};
circleCentersY = {'data':[]};
patchSums = {'data':[]};
patchTones = {'data':[]};
var changeMinMax = false;
var frameCount = 3;
xMin = 99999;
xMax = -99999;
yMin = 99999;
yMax = -99999;
var aSineWave;


//parameters
var baseTone = 140;
var playIdx = -1;
numNeighborsX = 5;
numNeighborsY = 1;
radius = 20;
circleCenterX = 30;
circleCenterY = 30;

function init() {
  localVideo = document.querySelector('#localVideo');;
  output = document.querySelector('#output');
  oContext = output.getContext('2d');
  var localStream;

  localVideo.addEventListener('play', function() {
    draw(localVideo, oContext, localVideo.clientWidth,
     localVideo.clientHeight);
  });
  startMedia();

  var actxCall = AudioContext;
  aContext = new actxCall();
  aSineWave = new SineWave(aContext);
  //setMooreNeighborHood(80);
  layout5Instrument();
  //playTone(80);
}

function startMedia() {
  var constraints = {video: true, audio: true};
  getUserMedia(constraints, handleUserMedia, handleUserMediaError);
  console.log('Getting user media with constraints', constraints);
}

function handleUserMedia(stream) {
  console.log('Adding local stream.');
  if (localVideo == null) {
    localVideo = document.querySelector('#localVideo');
  }
  attachMediaStream(localVideo, stream);
  localStream = stream;
}

function setMooreNeighborHood(tone) {
  var mult = 2.0;
  changeMinMax = false;
  for(var i=0; i<numNeighborsY; i++) {
   for(var j=0; j<numNeighborsX; j++) {
	var idx = j + (i * numNeighborsX);
	circleCentersX.data[idx] = circleCenterX + ((j-1)*(radius*mult));
	circleCentersY.data[idx] = circleCenterY + ((i-1)*(radius*mult));
	if(circleCentersX.data[idx] < xMin) {
		xMin = circleCentersX.data[idx];
		changeMinMax = true;
        }
	if(circleCentersX.data[idx] > xMax) {
                xMax = circleCentersX.data[idx];
		changeMinMax = true;
        }
	if(circleCentersY.data[idx] < yMin) {
                yMin = circleCentersY.data[idx];
		changeMinMax = true;
        }
        if(circleCentersY.data[idx] > yMax) {
                yMax = circleCentersY.data[idx];
		changeMinMax = true;
        }
   }
  }
}

function layoutInstrument() {
  var mult = 10.0;
  var newTone = 0.0;
  var prevTone = baseTone;
  for(var i=0; i<numNeighborsY; i++) {
	prevTone = prevTone + 20;
   for(var j=0; j<numNeighborsX; j++) {
        var idx = j + (i * numNeighborsX);
        circleCentersX.data[idx] = circleCenterX + (j*(radius*mult));
        circleCentersY.data[idx] = circleCenterY + (i*(radius*mult));
        
        newTone = prevTone + (1.0595*3);
        patchTones[idx] = newTone;
        prevTone = newTone;
        console.log("Setting cirlce:",idx,newTone,circleCentersX.data[idx],circleCentersY.data[idx]);
     }
   }
}

function layout5Instrument() {
  var mult = 10.0;
  var newTone = 0.0;
  var prevTone = baseTone;
  circleCentersX.data[0] = 320;
  circleCentersY.data[0] = 240;
  patchTones.data[0] = baseTone;

  circleCentersX.data[1] = 64;
  circleCentersY.data[1] = 64;
  patchTones.data[1] = baseTone * Math.pow(1.0595,4.0);

  circleCentersX.data[2] = 576;
  circleCentersY.data[2] = 64;
  patchTones.data[2] = baseTone * Math.pow(1.0595,5.0);

  circleCentersX.data[3] = 64;
  circleCentersY.data[3] = 416;
  patchTones.data[3] = baseTone * Math.pow(1.0595,7.0);

  circleCentersX.data[4] = 576;
  circleCentersY.data[4] = 416;
  patchTones.data[4] = baseTone * Math.pow(1.0595,11.0);

  for(var i=0; i<5; i++) {
   console.log("Tones are:",patchTones.data[i]);
  }

}


function playFourChord(freq) {
  var ctx = aContext;
  var o = ctx.createOscillator();
  var o1 = ctx.createOscillator();
  var o2 = ctx.createOscillator();
  var o3 = ctx.createOscillator();
  var g = ctx.createGain();

  o.frequency.value = freq;
  o.type = "sawtooth";

  o1.frequency.value = freq+17.5;
  o1.type = "sawtooth";

  o2.frequency.value = freq+23.5;
  o2.type = "sawtooth";

  o3.frequency.value = freq-40.5;
  o3.type = "sawtooth";

  

  o.connect(g);
  o1.connect(g);
  o2.connect(g);
  o3.connect(g);

  g.connect(ctx.destination);
  g.gain.setValueAtTime(0.0,ctx.currentTime);

  o.start(ctx.currentTime);
  o1.start(ctx.currentTime);
  o2.start(ctx.currentTime);
  o3.start(ctx.currentTime);

  g.gain.linearRampToValueAtTime(0.25, ctx.currentTime+0.5);
  g.gain.linearRampToValueAtTime(0.5, ctx.currentTime+0.75);
  g.gain.linearRampToValueAtTime(0.75, ctx.currentTime+1.00);
}

function playTone(freq) {
  var ctx = aContext;
  var o = ctx.createOscillator();
  var g = ctx.createGain();
  o.frequency.value = freq;
  o.type = "triangle";

  o.connect(g);
  g.connect(ctx.destination);
  g.gain.setValueAtTime(0.0,ctx.currentTime);
  o.start(ctx.currentTime);
  g.gain.linearRampToValueAtTime(0.25, ctx.currentTime+1.0);
  g.gain.linearRampToValueAtTime(1.0, ctx.currentTime+2.0);
  g.gain.linearRampToValueAtTime(2.0, ctx.currentTime+3.00);
}


  function draw(v,c,w,h) {
    
    try {
      if (output.width != localVideo.clientWidth) {
        output.width = localVideo.clientWidth;
        output.height = localVideo.clientHeight;
        output.style.width = localVideo.clientWidth +'px';
        output.style.height = localVideo.clientHeight + 'px';
      }
      c.drawImage(v,0,0,output.width,output.height);
      output.style.MozAnimationPlayState = 'running';
      var imgData = c.getImageData(0, 0, output.width,output.height);
      if(oldDataCheck != 1) {
	oldData = {'data':[]};
        for(var i=0; i<output.width*output.height*4; i++) {
	  oldData.data[i] = imgData.data[i];
         }
      }
      for(var i=0; i<output.height; i++) {
       for(var j=0; j<output.width; j++) {
         var idx = (j + (i * output.width))*4;
         imgData.data[idx] = imgData.data[idx+1] = imgData.data[idx+2] = imgData.data[idx]*0.3+imgData.data[idx+1]*0.59+imgData.data[idx+2]*0.1;
	 var diff = imgData.data[idx] - oldData.data[idx];
	 oldData.data[idx] = oldData.data[idx+1] = oldData.data[idx+2] = imgData.data[idx];
	 imgData.data[idx] = imgData.data[idx+1] = imgData.data[idx+2] = diff;
         findMaxChangeInNeighborHood(j,i,diff);
	 }
       }
      //setNewCenter();
      drawCircles();
      //drawCircle(radius,circleCenterX,circleCenterY);
      if(playIdx == -1)
	 playMaxPatch();
      //drawLinePath();
      oldDataCheck = 1;
      resetSums();
    } catch (e) {
      if (e.name != "NS_ERROR_NOT_AVAILABLE") {
        throw e;
      }
    }
    frameCount++;
    setTimeout(draw,20,v,oContext,output.width,output.height);
   
  }

function resetSums() {
  for(var i=0; i<numNeighborsX*numNeighborsY; i++) {
     patchSums.data[i] = 0;
  }
}


function findMaxChangeInNeighborHood(x,y,diff) {
   for(var i=0; i<numNeighborsX*numNeighborsY; i++) {
        if( (x >= (circleCentersX.data[i] - radius) && x < (circleCentersX.data[i] + radius)) && 
	    (y >= (circleCentersY.data[i] - radius) && y < (circleCentersY.data[i] + radius))) {
		patchSums.data[i] = patchSums.data[i] + Math.abs(diff);
	}
    }
}

function setNewCenter() {

  var min = 9999999;
  var max = -9999999;
  var tol = 3500;
  for(var i=0; i<numNeighborsX*numNeighborsY; i++) {
     if(patchSums.data[i] > max) {
        max = patchSums.data[i];
     }
  } 
  for(var i=0; i<numNeighborsX*numNeighborsY; i++) {
     if(max == patchSums.data[i]) {
	if(max > tol) {

	  var xDiff = (circleCenterX - circleCentersX.data[i]);
	  var yDiff = (circleCenterY - circleCentersY.data[i]);
	  var magDiff = Math.sqrt((xDiff*xDiff)+(yDiff*yDiff));
	  baseTone = xDiff+yDiff+baseTone;
	  circleCenterX = circleCentersX.data[i];
          circleCenterY = circleCentersY.data[i];
	  baseTone = Math.sqrt((circleCenterX*circleCenterX)+(circleCenterY*circleCenterY));
	  playTone(baseTone);
	  setMooreNeighborHood(baseTone);
	}
     }
  }

}

function playMaxPatch() {

  var max = -9999999;
  var tol = 13500;
  for(var i=0; i<numNeighborsX*numNeighborsY; i++) {
     if(patchSums.data[i] > max) {
        max = patchSums.data[i];
        playIdx = i;
     }
  }
  if(playIdx != -1 && max > tol) {
    aSineWave.setFrequency(patchTones.data[playIdx]);
    aSineWave.play();
    //playTone(patchTones.data[playIdx]);
  }
  playIdx = -1;

}


function handleUserMediaError(error){
  console.log('navigator.getUserMedia error: ', error);
}

function drawLinePath() {
  if(points.length > 1) {
  var ctx = oContext;
  ctx.strokeStyle = 'rgba(230,87,0,0.8)';
  ctx.beginPath();
  for(var i=0; i<points.length; i++) {
    if(i == 0) 
      ctx.moveTo(points[i].x,points[i].y);
    ctx.lineTo(points[i].x,points[i].y);
  }
  ctx.stroke();
 }
}

function drawCircles() {
  for(var i=0; i<numNeighborsX*numNeighborsY; i++) {
     drawCircle(radius,circleCentersX.data[i],circleCentersY.data[i]);
  }
}

function drawCircle(r,x,y) {
  var ctx = oContext;
  var scale = 4.0;
  ctx.lineWidth = 2;
  ctx.strokeStyle = 'rgba(230,87,0,0.8)';
  ctx.beginPath();
  ctx.arc(x,y,r,0,2.0*Math.PI);
  ctx.stroke();
}


</script>

</head>

<body>
  <div id='container'>
    <div id='videos'>
      <canvas id='output'></canvas>
      <video id='localVideo' muted  autoplay style='visibility:hidden'></video>
    </div>
  </div>
</body>
</html>
