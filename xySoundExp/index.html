<!DOCTYPE html>
<html>
<head>
  <title>Web Fun</title>
  <meta charset="utf-8">
  <!--<link rel="shortcut icon" href="/favicon.png"> -->

  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
  <script src="//europa.kradradio.com:8040/mootools-core-1.4.5-full-nocompat.js"></script>
  <script src="//europa.kradradio.com:8040/mootools-more-1.4.0.1.js"></script>

  <script type="text/javascript" src="adapter.js"></script>
  <script>

window.onload = init;

var aContext;
var oConext;
var output;
var localVideo;


function init() {
  localVideo = document.querySelector('#localVideo');;
  output = document.querySelector('#output');
  oContext = output.getContext('2d');
  var localStream;

  localVideo.addEventListener('play', function() {
    draw(localVideo, oContext, localVideo.clientWidth,
     localVideo.clientHeight);
  });

  startMedia();

  var actxCall = AudioContext;
  aContext = new actxCall();
  playTone(80);
}

function startMedia() {
  var constraints = {video: true, audio: true};
  getUserMedia(constraints, handleUserMedia, handleUserMediaError);
  console.log('Getting user media with constraints', constraints);
}

function handleUserMedia(stream) {
  console.log('Adding local stream.');
  if (localVideo == null) {
    localVideo = document.querySelector('#localVideo');
  }
  attachMediaStream(localVideo, stream);
  localStream = stream;
}

function playTone(freq) {
  var ctx = aContext;
  var o = ctx.createOscillator();
  var g = ctx.createGain();
  o.frequency.value = freq;
  o.type = "sawtooth";

  o.connect(g);
  g.connect(ctx.destination);
  g.gain.setValueAtTime(0.0,ctx.currentTime);
  o.start(ctx.currentTime);
  g.gain.linearRampToValueAtTime(0.7, ctx.currentTime+0.1);
  g.gain.linearRampToValueAtTime(0.5, ctx.currentTime+0.3);
  g.gain.linearRampToValueAtTime(0.0, ctx.currentTime+0.6);
}

var oldData;
var threshold = 75;
  function draw(v,c,w,h) {

    try {
      if (output.width != localVideo.clientWidth) {
        output.width = localVideo.clientWidth;
        output.height = localVideo.clientHeight;
        output.style.width = localVideo.clientWidth +'px';
        output.style.height = localVideo.clientHeight + 'px';
      }
      c.drawImage(v,0,0,output.width,output.height);
      output.style.MozAnimationPlayState = 'running';
      var imgData = c.getImageData(0, 0, output.width,
       output.height);
      oldData = oldData ? oldData : imgData;
      var xLoc,yLoc,mag;
      xLoc = -1.0;
      yLoc = -1.0;
      for(var i=0; i<output.height; i++) {
       for(var j=0; j<output.width; j++) {
         var idx = j + (i * output.width * 4.0);
         if(oldData.data[idx+1] - imgData.data[idx+1] > threshold || oldData.data[idx+2] - imgData.data[idx+2] > threshold || oldData.data[idx+3] - imgData.data[idx+3] > threshold) {
	   if(j != xLoc || i != yLoc) {
		xLoc = j;
           	yLoc = i;
           	mag = Math.sqrt((xLoc*xLoc)+(yLoc*yLoc));
           	playTone(mag*0.5);
	   	i = output.height;
	   break;
           }
	 }

       }
      }
      oldData = c.getImageData(0,0,output.width,output.height);
      c.putImageData(imgData, 0, 0);
      drawCircle(xLoc,yLoc);
    } catch (e) {
      if (e.name != "NS_ERROR_NOT_AVAILABLE") {
        throw e;
      }
    }

    setTimeout(draw,20,v,oContext,output.width,output.height);
  }

function handleUserMediaError(error){
  console.log('navigator.getUserMedia error: ', error);
}

function drawCircle(x,y) {
  console.log("about ot get oContext!");
  var ctx = oContext;
  var scale = 4.0;
  ctx.lineWidth = 2;
  ctx.strokeStyle = 'rgba(230,87,0,0.8)';
  ctx.beginPath();
  console.log("Stokeing cock with",x,y);
  ctx.arc(x,y,10,0,2.0*Math.PI);
  ctx.stroke();
}


</script>

</head>

<body>
  <div id='container'>
    <div id='videos'>
      <canvas id='output'></canvas>
      <video id='localVideo' muted  autoplay style='visibility:hidden'></video>
    </div>
  </div>
</body>
</html>
