<!DOCTYPE html>
<html>
  <head>
    <title>Web Fun</title>
      <meta charset="utf-8">
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
        <script type="text/javascript" src="adapter.js"></script>
        <script type="text/javascript" src="sinewave.js"></script>
        <script type="text/javascript" src="SoundShape.js"></script>
        <script>
                
            window.onload = init;
            var aContext;
            var oConext;
            var output;
            var localVideo;
            var soundShapes = [];
            var collectOldDataCount = 180;
            var oldData = {'data':[]};
            var frameCount = 0;
            var numShapes = 4;
            
            function init() {
                localVideo = document.querySelector('#localVideo');;
                output = document.querySelector('#output');
                oContext = output.getContext('2d');
                var localStream;
                    
                window.requestAnimFrame = (function(callback) {
                    return window.requestAnimationFrame ||
                        window.webkitRequestAnimationFrame ||
                        window.mozRequestAnimationFrame ||
                        windowoRequestAnimationFrame ||
                        window.msRequestAnimationFrame ||
                        function(callback) { window.setTimeout(callback, 1000 / 60);};
                })();
                                                
                var actxCall = window.webkitAudioContext || window.AudioContext;
                aContext = new actxCall();
                    
                var origX = 30;
                var origY = -60;
                var baseTone = 440;
                var sRad = 30;
                var circleSpacing = output.width/numShapes;
                    
                for(var i=0; i<numShapes; i++) {
                    var x = origX + ((i+1)*sRad) + ((i+1)*circleSpacing);
                    var y = origY - sRad;
                    aSoundShape = new SoundShape(i,oContext, aContext, {'x':x, 'y':y},baseTone, sRad);
                    aSoundShape.setAmplitude(0.1);
                    aSoundShape.setDefaults((new Date()).getTime(),false,0.1);
                    soundShapes.push(aSoundShape);
                    console.log("SoundShape:",i,x,y,sRad,baseTone * Math.pow(1.05946,soundShapes[i].MinorChord[i]),circleSpacing);
                }
                console.log("Made soundShapes:",soundShapes.length);
            }
            
            startMedia();
            
            function startMedia() {
                var constraints = {video: true, audio: true};
                getUserMedia(constraints, handleUserMedia, handleUserMediaError);
                console.log('Getting user media with constraints', constraints);
            }
            
            function handleUserMedia(stream) {
                console.log('Adding local stream.');
                if (localVideo == null) {
                    localVideo = document.querySelector('#localVideo');
                }
                attachMediaStream(localVideo, stream);
                localStream = stream;
            }
            
            function animate(video,context) {
                if (output.width != localVideo.clientWidth) {
                    output.width = localVideo.clientWidth;
                    output.height = localVideo.clientHeight;
                    output.style.width = localVideo.clientWidth +'px';
                    output.style.height = localVideo.clientHeight + 'px';
                }
                context.drawImage(video,0,0,output.width,output.height);
                var imgData = context.getImageData(0, 0, output.width,output.height);
             
                if(frameCount < collectOldDataCount) {
                    oldData = context.getImageData(0, 0, output.width,output.height);
                } else {
                    for(var i=0; i<soundShapes.length; i++) {
                        var time = (new Date()).getTime() - soundShapes[i].startTime;
                        //
                        if(time > 0) {
                            soundShapes[i].updateSoundShape(imgData,oldData,time);
                        }
                    }
                }
            requestAnimFrame(function() { animate(video, context); });
            frameCount++;
            }
        
            function handleUserMediaError(error){
                console.log('navigator.getUserMedia error: ', error);
            }
        
            setTimeout(function() { animate(localVideo,oContext); }, 2000);
        </script>
    </head>
  <body>
      <div id='container'>
          <div id='videos'>
              <canvas id='output'></canvas>
              <video id='localVideo' muted  autoplay style='visibility:hidden'></video>
          </div>
      </div>
  </body>
</html>
