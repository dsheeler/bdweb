<!DOCTYPE html>
<html>
  <head>
    <title>Web Fun</title>
      <meta charset="utf-8">
        <link rel="stylesheet" href="http://code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
        <script src="http://code.jquery.com/jquery-1.10.2.js"></script>
        <script src="http://code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
        <script type="text/javascript" src="adapter.js"></script>
        <script type="text/javascript" src="sinewave.js"></script>
        <script type="text/javascript" src="SoundShape.js"></script>
        <link rel="stylesheet" href="ss.css">
        <script>
                
            window.onload = init;
            var aContext;
            var oConext;
            var output;
            var localVideo;
            var soundShapes = [];
            var collectOldDataCount = 2;
            var oldData = {'data':[]};
            var frameCount = 0;
            var numShapes = 4;
            var drawDots = false;
            var useMotionType = 0; //0 = static, 1 = linear velocity, 2 = accel constant, 3 = accel change
            function init() {
                localVideo = document.querySelector('#localVideo');;
                output = document.querySelector('#output');
                oContext = output.getContext('2d');
                var localStream;
                    
                window.requestAnimFrame = (function(callback) {
                    return window.requestAnimationFrame ||
                        window.webkitRequestAnimationFrame ||
                        window.mozRequestAnimationFrame ||
                        windowoRequestAnimationFrame ||
                        window.msRequestAnimationFrame ||
                        function(callback) { window.setTimeout(callback, 1000 / 60);};
                })();
                                                
                var actxCall = window.webkitAudioContext || window.AudioContext;
                aContext = new actxCall();
                    
                var origX = 30;
                var origY = -60;
                var baseTone = 440;
                var sRad = 30;
                var circleSpacing = output.width/numShapes;
                    
                for(var i=0; i<numShapes; i++) {
                    var x = origX + ((i+1)*sRad) + ((i+1)*circleSpacing);
                    var y = origY - sRad;
                    aSoundShape = new SoundShape(i,oContext, aContext, {'x':x, 'y':y},baseTone, sRad);
                    aSoundShape.setAmplitude(0.1);
                    aSoundShape.setMotionIsLinear(true);
                    aSoundShape.setYVelocity(0.5);
                    aSoundShape.setGravity(200.0);
                    
                    aSoundShape.setDefaults((new Date()).getTime());
                    soundShapes.push(aSoundShape);
                    console.log("SoundShape:",i,x,y,sRad,baseTone * Math.pow(1.05946,soundShapes[i].SequenceOne[i]),circleSpacing);
                }
                console.log("Made soundShapes:",soundShapes.length);
            }
            
            startMedia();
            
            function startMedia() {
                var constraints = {video: true, audio: true};
                getUserMedia(constraints, handleUserMedia, handleUserMediaError);
                console.log('Getting user media with constraints', constraints);
            }
            
            function handleUserMedia(stream) {
                console.log('Adding local stream.');
                if (localVideo == null) {
                    localVideo = document.querySelector('#localVideo');
                }
                attachMediaStream(localVideo, stream);
                localStream = stream;
            }
            
            function animate(video,context) {
                if (output.width != localVideo.clientWidth) {
                    output.width = localVideo.clientWidth;
                    output.height = localVideo.clientHeight;
                    output.style.width = localVideo.clientWidth +'px';
                    output.style.height = localVideo.clientHeight + 'px';
                }
                context.drawImage(video,0,0,output.width,output.height);
                var imgData = context.getImageData(0, 0, output.width,output.height);
             
                if(frameCount % collectOldDataCount == 0) {
                    oldData = context.getImageData(0, 0, output.width,output.height);
                }
                if(drawDots) {
                    for(var i=0; i<soundShapes.length; i++) {
                        var time = (new Date()).getTime() - soundShapes[i].startTime;
                        if(time > 0) {
                            soundShapes[i].updateSoundShape(imgData,oldData,time);
                        }
                    }
                }
                requestAnimFrame(function() { animate(video, context); });
                frameCount++;
            }
        
            function handleUserMediaError(error){
                console.log('navigator.getUserMedia error: ', error);
            }
        
            function setDrawDots() {
                if(!drawDots) {
                    drawDots = true;
                } else {
                    drawDots = false;
                }
            }
            function setMotionType(mType) {
                if(mType == 0) {
                    $( "#velocity_slider").hide();
                    $( "#gravity_slider").hide();
                    $( "#velocity").hide();
                    $( "#gravity" ).hide();
                }
                if(mType == 1) {
                    $( "#velocity_slider").show();
                    $( "#gravity_slider").hide();
                    $( "#velocity").show();
                    $( "#gravity" ).hide();
                    for(var i=0; i<soundShapes.length; i++) {
                        soundShapes[i].setMotionIsLinear(true);
                        console.log("Set motion to linear!");
                    }
                }
                if(mType == 2) {
                    $( "#velocity_slider").hide();
                    $( "#gravity_slider").show();
                    $( "#velocity").hide();
                    $( "#gravity" ).show();
                    for(var i=0; i<soundShapes.length; i++) {
                        soundShapes[i].setMotionIsLinear(false);
                        //soundShapes[i].setAccelIsUniform(true);
                    }
                }
            }
        
            function changeYVelocity(vel) {
                for(var i=0; i<soundShapes.length; i++) {
                    soundShapes[i].setYVelocity(vel);
                }
            }
        
            function changeGravity(gr) {
                for(var i=0; i<soundShapes.length; i++) {
                    soundShapes[i].setGravity(gr);
                }
            }

            function setRandomizeXPos() {
                for(var i=0; i<soundShapes.length; i++) {
                    soundShapes[i].randomizeXStartPos ?
                    soundShapes[i].setRandomizeXPos(false):
                    soundShapes[i].setRandomizeXPos(true);
                }
            }
        
            function setRandomizeYPos() {
                for(var i=0; i<soundShapes.length; i++) {
                    soundShapes[i].randomizeYStartPos ?
                    soundShapes[i].setRandomizeYPos(false):
                    soundShapes[i].setRandomizeYPos(true);
                }
            }

            function setRandomizeYVel() {
                for(var i=0; i<soundShapes.length; i++) {
                    soundShapes[i].setYVelocity(soundShapes[i].yVelocity*(Math.random()*2.0));
                }
            }
        
            function setRandomizeGravity() {
                for(var i=0; i<soundShapes.length; i++) {
                    soundShapes[i].setGravity(soundShapes[i].gravity*(Math.random()*2.0));
                }
            }

            function setRandomizeRestartTime() {
                for(var i=0; i<soundShapes.length; i++) {
                    soundShapes[i].randomizeRestartTime ?
                    soundShapes[i].setRandomizeRestartTime(false):
                    soundShapes[i].setRandomizeRestartTime(true);
                }
            }

            setTimeout(function() { animate(localVideo,oContext); }, 2000);
        </script>
        <script>
            //stop/start button
            $(function() {
              $("input[type=submit]").button().click(function( event ) { setDrawDots(); })
            });
            //randomize xpos toggle
            $(function() {
              $("#randXPos").button().click(function( event ) { setRandomizeXPos(); })
            });
            //randomize ypos toggle
            $(function() {
              $("#randYPos").button().click(function( event ) { setRandomizeYPos(); })
            });
            //randomize yvel toggle
            $(function() {
              $("#randYVel").button().click(function( event) { setRandomizeYVel(); })
            });
            //randomize yaccel toggle
            $(function() {
              $("#randYAccel").button().click(function( event ) { setRandomizeGravity(); })
            });
            //randomize restart time
            $(function() {
              $("#randSTime").button().click(function( event ) { setRandomizeRestartTime(); })
            });

            //motion type selection
            $(function() {
              $("#motionType").selectmenu({change:function(event,data){setMotionType(data.item.value);}});
            });
            //velocity slider
            $(function() {
              $( "#velocity_slider" ).slider({
                range: false,
                min: 0.1,
                max: 10.0,
                step: 0.1,
                value: 0.5,
                slide: function( event, ui ) {
                $( "#velocity" ).val( ui.value );
                changeYVelocity(ui.value);
                }
              });
              $( "#velocity" ).val( $( "#velocity_slider" ).slider( "value" ) );
            });
            //Gravity slider
            $(function() {
              $( "#gravity_slider" ).slider({
                    range: false,
                    min: 5.0,
                    max: 500.0,
                    step: 5.0,
                    value: 25,
                    slide: function( event, ui ) {
                    $( "#gravity" ).val( ui.value );
                    changeGravity(ui.value);
                    }
                });
                $( "#gravity" ).val( $( "#gravity_slider" ).slider( "value" ) );
              });
        </script>
    </head>
  <body>
      <div id='container'>
          <div id='videos'>
              <canvas id='output'></canvas>
              <video id='localVideo' muted  autoplay style='visibility:hidden'></video>
          </div>
      </div>
      <div>
          <input type="submit" value="Start/Stop">
      </div>
      <div>
          <table>
              <td><input type="checkbox" id="randXPos"><label for="randXPos">RandXPos</label></td>
              <td><input type="checkbox" id="randYPos"><label for="randYPos">RandYPos</label></td>
              <td><input type="checkbox" id="randYVel"><label for="randYVel">RandYVel</label></td>
              <td><input type="checkbox" id="randYAccel"><label for="randYAccel">RandYAccel</label></td>
              <td><input type="checkbox" id="randSTime"><label for="randSTime">RandSTime</label></td>
          </table>
      </div>
      <div>
          <style>
          label {
          display: block;
          margin: 20px 0 0 0;
          }
          select {
          width: 200px;
          }
          </style>
          <form action="#">
          <label for="motionType">Motion Type:</label>
          <select name="motionType" id="motionType">
              <option value="0">Static</option>
              <option value="1" selected>Linear</option>
              <option value="2">Gravity</option>
          </select>
          </form>
      </div>
      <p>
      <label for="velocity" class="hideVelocity">Linear Velocity:</label>
      <input type="text" id="velocity" readonly style="border:0; color:#f6931f; font-weight:bold;">
      </p>
      <div id="velocity_slider"></div>
      <p>
      <label for="gravity" class="hideGravity">Gravity:</label>
      <input type="text" id="gravity" readonly style="border:0; color:#f6931f; font-weight:bold;">
          </p>
          <div id="gravity_slider"></div>
          
  </body>
</html>
